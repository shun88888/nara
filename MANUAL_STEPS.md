# DM機能 手動設定手順

## ステップ1: データベースマイグレーションの適用

1. **Supabase Dashboardを開く**
   - ブラウザで https://supabase.com/dashboard にアクセス
   - プロジェクト「nara」を選択

2. **SQL Editorを開く**
   - 左側のメニューから「SQL Editor」をクリック
   - 「+ New query」ボタンをクリック

3. **マイグレーションSQLを実行**
   - `supabase/migrations/20250101000007_create_messages.sql` ファイルの内容をコピー
   - SQL Editorに貼り付け
   - 「Run」ボタンをクリック

4. **成功を確認**
   - 下部に「Success. No rows returned」と表示されればOK
   - エラーが出た場合はメッセージを確認してください

---

## ステップ2: Realtime機能の有効化

1. **Database Replicationページを開く**
   - 左側のメニューから「Database」→「Replication」をクリック

2. **messagesテーブルのReplicationを有効化**
   - テーブル一覧から「messages」を探す
   - 右側のトグルスイッチをON（青色）にする
   - 確認ダイアログが出たら「Enable」をクリック

3. **同様にconversationsテーブルも有効化**
   - 「conversations」テーブルのトグルスイッチもONにする

4. **完了**
   - 両方のテーブルが青色になっていればOK！

---

## 動作確認

### テスト手順

1. **ユーザーアカウントでログイン**
   - 予約を1つ作成
   - 予約詳細画面から「メッセージを送る」をタップ
   - メッセージを送信

2. **事業者アカウントでログイン（別デバイスor エミュレーター）**
   - メッセージタブを開く
   - ユーザーからのメッセージが表示されることを確認
   - 返信を送信

3. **ユーザー側でリアルタイム受信を確認**
   - チャット画面を開いたまま
   - 事業者からの返信が自動的に表示されることを確認

---

## トラブルシューティング

### マイグレーションエラーが出る場合
- エラーメッセージを確認
- テーブルが既に存在する場合: 既存のテーブルを削除してから再実行
- 関数が既に存在する場合: `DROP FUNCTION IF EXISTS` を追加

### Realtimeが動作しない場合
- Replicationが有効になっているか再確認
- アプリを再起動（開発サーバーも再起動）
- Supabase Dashboardの「API」→「Realtime」でステータス確認

### メッセージが送信できない場合
- RLSポリシーが正しく設定されているか確認
- ブラウザのコンソールログでエラーメッセージを確認
- ユーザーIDが正しく取得できているか確認

---

## 完了後の確認項目

- [x] マイグレーションSQL実行成功
- [x] messages テーブルのRealtime有効化
- [x] conversations テーブルのRealtime有効化
- [ ] ユーザー→事業者へのメッセージ送信テスト
- [ ] 事業者→ユーザーへのメッセージ送信テスト
- [ ] リアルタイム受信のテスト

すべてチェックが付いたら完了です！🎉
